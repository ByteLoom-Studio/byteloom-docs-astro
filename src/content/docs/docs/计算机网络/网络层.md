---
title : 网络层
sidebar:
  order : 5
---
> Author : CG、WZF

## 基本功能与作用
网络层是OSI七层模型的第三层，其核心功能是：

**路由选择**（Routing）：为数据包选择一条从源主机到目的主机的最优路径。路由器通过动态或静态的路由协议决定转发方向。

**逻辑寻址**（Logical Addressing）：为每个网络设备分配唯一的地址（如IP地址），实现跨网络的通信。负责IP地址的分配与解析。

**分段与重组**（Fragmentation & Reassembly）：由于底层链路的MTU（最大传输单元）限制，网络层将大数据包拆分成多个小片（分片）。接收端负责重组这些数据片还原为完整包。

**转发与中继**（Forwarding）：网络层设备（如路由器）根据目的地址选择下一跳，执行数据包的转发。

**差错处理与控制**（Error Handling & Control）（非主要功能）：网络层通常不保证可靠传输，但某些协议会提供路径失效通知。

---

## 主要协议
### IP协议（Internet Protocol）
IP协议是网络层的核心协议，面向无连接，尽力而为（best-effort）。同时支持IPv4和IPv6。

主要功能有：

+ 提供逻辑地址（IP地址）；
+ 数据包的封装、转发和分片；
+ 不保证可靠性，不提供重传；

IP协议的体现方式是，每个IP包头中包含源IP、目的IP、TTL、分片信息等字段；路由器根据目的IP查找转发表，决定下一跳。

---

### ICMP协议（Internet Control Message Protocol）
ICMP协议，用于传输控制消息，如错误报告、网络状态检测；它不传输数据，仅用于**诊断和报告网络错误**；ICMP是IP协议的伴生协议

常见用途有，ping 命令使用ICMP Echo请求/应答；通知目标不可达、TTL超时、重定向等；

ICMP协议的体现方式是，ICMP消息封装在IP包中，作为IP负载；路由器或主机在出错时发出ICMP报文。

---

### ARP协议（Address Resolution Protocol）
ARP协议严格地说属于数据链路层与网络层之间的接口，主要功能是将IP地址解析为MAC地址；在局域网中实现从逻辑地址到物理地址的映射；

体现方式是主机广播ARP请求，目标主机回复ARP应答；每个主机会维护一个ARP缓存表；

ARP协议有一个常见攻击考点——ARP欺骗，可导致中间人攻击（MITM）。

---

### 路由协议（Routing Protocols）
路由协议是网络层中用于指导数据包在不同网络间转发路径的规则和算法

由信息的维护方式，可分为静态路由协议和动态路由协议

由作用范围，可分为内部网关协议（IGP） 和外部网关协议（EGP）

**内部网关协议（IGP，Interior Gateway Protocol）**

用于一个自治系统（AS）内部的路由信息交换。

常见的 IGP 协议包括：

+ RIP（Routing Information Protocol）
+ OSPF（Open Shortest Path First）
+ IS-IS（Intermediate System to Intermediate System）
+ EIGRP（Cisco 私有）

**外部网关协议（EGP，Exterior Gateway Protocol）**

用于不同自治系统之间的路由交换。

唯一广泛使用的 EGP 是 BGP（Border Gateway Protocol），用于互联网的主干路由协议。

---

以下是一些常见的路由协议，这些路由协议虽然工作在网络层，但它们是供路由器之间使用，决定如何建立路由表。

**RIP（Routing Information Protocol）**

基于距离向量算法，度量单位是跳数；最多支持15跳；简单但收敛慢，适用于小型网络。

**OSPF（Open Shortest Path First）*提到的考点**

基于链路状态协议，使用Dijkstra算法；支持大规模网络；更快收敛，支持区域划分。

**BGP（Border Gateway Protocol）**

用于不同自治系统（AS）之间；是互联网核心路由协议；保证互联网的全球可达性。

---

### 路由协议总结
路由协议分为静态路由协议和动态路由协议两大类。

静态路由协议是由网络管理员手动配置路由条目，网络拓扑结构变化时不会自动更新，适用于结构简单、变化不频繁的小型网络。

动态路由协议通过路由器之间自动交换路由信息，根据特定的算法（如 Dijkstra、Bellman-Ford）动态更新路由表。动态路由协议又可分为内部网关协议（IGP）和外部网关协议（EGP）。

在 IGP 中，常见的协议包括：

+ RIP（路由信息协议）：基于距离向量算法，以“跳数”为度量标准，最大跳数为15，适用于小型网络。
+ OSPF（开放最短路径优先）：基于链路状态算法，以“带宽”为度量单位，支持大型网络，常用于企业和校园网络。
+ IS-IS（中间系统到中间系统）：与 OSPF 类似，同样是链路状态协议，也常用于自适应网络。

而 EGP 中主要使用的是：

BGP（边界网关协议）：目前互联网中唯一广泛使用的 EGP。它基于路径向量算法，以“策略”、“路径”、“自治域”等为标准，支持大规模网络间的策略控制与路由选择。



---

## IP地址和子网划分
**IP地址（Internet Protocol Address）** 是用于唯一标识网络中每一台主机的地址。

IPv4其实就代表了第四个版本，v就是version。IPv4地址是32位的二进制数，通常用 点分十进制 表示，有如下的地址格式：`192.168.1.1`

每一段是一个 8位二进制数（0-255）。

IPv4地址分为两部分：网络号（Network ID）和主机号（Host ID）

---

### 子网掩码（Subnet Mask）
子网掩码用于将IP地址划分为网络部分和主机部分。

例如：IP地址：`192.168.1.1`对应的子网掩码为`255.255.255.0`（即 24 位）

网络部分是前24位，主机部分是后8位。

子网掩码有一个CIDR表示法（无类域间路由），全称是CIDR（Classless Inter-Domain Routing），用“斜杠+位数”表示子网掩码。

例如：`192.168.1.0/24` 等价于子网掩码 `255.255.255.0`

**子网划分的好处**

+ 提高地址利用率：避免浪费IP地址资源。
+ 增强网络安全性：子网之间可用防火墙隔离。
+ 提升管理效率：便于网络管理和故障排查。
+ 控制广播域：减小广播风暴，提高网络性能。

**子网划分的过程**

1. **确定需求：**有多少个子网？每个子网需要多少主机？
2. **使用公式计算所需位数：**
    - 子网数所需位数：2^n >= 子网数
    - 每个子网主机数所需位数：2^m - 2 >= 主机数（减2是因为去掉网络地址和广播地址）
3. **生成子网掩码**：原始掩码 + 所用子网位数 = 新子网掩码
4. **列出子网划分结果**：网络地址、子网掩码、主机IP范围、广播地址、默认网关（通常是主机范围内的第一个或最后一个地址）

**子网划分例子**

我们从一个典型的场景开始：假设你拥有一个网络地址为 192.168.10.0/24 的私有IP段，你的任务是将其划分成至少6个子网，并列出每个子网的网络地址、广播地址、可用主机范围以及子网掩码。为了完成这个任务，首先我们需要确定每个子网至少能容纳多少主机。尽管题目没要求每个子网的主机数量，但我们必须按照能划分出“至少6个子网”为前提，来计算合适的子网位数。

因为原始网络是 /24，也就是有8个（32-24）位用于主机编号（2⁸ = 256个地址，其中去除网络地址和广播地址，可用254个）。要从中划分出至少6个子网，我们需要“借”主机位来做子网位。我们通过计算，2ⁿ ≥ 6 得到 n=3（即借3个位可以生成2³=8个子网，满足要求）。于是，新的子网掩码就是 /24 + 3 = /27。换句话说，我们把原来的256个IP地址段平均分成了8个子网，每个子网大小为 2⁵ = 32 个地址（其中30个可用主机地址）。

接下来我们列出所有8个子网的信息。因为每个子网块有32个地址，它们的网络地址将依次是：

第一个子网：192.168.10.0/27

网络地址是192.168.10.0，广播地址是192.168.10.31，可用主机从192.168.10.1到192.168.10.30。

第二个子网：192.168.10.32/27

网络地址是192.168.10.32，广播地址是192.168.10.63，可用主机从192.168.10.33到192.168.10.62。

第三个子网：192.168.10.64/27

网络地址是192.168.10.64，广播地址是192.168.10.95，可用主机从192.168.10.65到192.168.10.94。

第四个子网：192.168.10.96/27

网络地址是192.168.10.96，广播地址是192.168.10.127，可用主机从192.168.10.97到192.168.10.126。

第五个子网：192.168.10.128/27

网络地址是192.168.10.128，广播地址是192.168.10.159，可用主机从192.168.10.129到192.168.10.158。

第六个子网：192.168.10.160/27

网络地址是192.168.10.160，广播地址是192.168.10.191，可用主机从192.168.10.161到192.168.10.190。

虽然我们这里只要求6个子网，但由于/27的子网掩码自然会生成8个，我们顺便也可以列出后两个：

第七个子网：192.168.10.192/27

网络地址是192.168.10.192，广播地址是192.168.10.223，可用主机从192.168.10.193到192.168.10.222。

第八个子网：192.168.10.224/27

网络地址是192.168.10.224，广播地址是192.168.10.255，可用主机从192.168.10.225到192.168.10.254。

当然平时作业1也是一个子网划分的例子，可以直接参考。这里我写一个解法，不贴图了。

首先需要统计每个VLAN的主机数量，进行分配

| VLAN | 主机数量 |
| --- | --- |
| LAN1 | 2 |
| LAN2 | 2 |
| LAN3 | 10 |
| LAN4 | 2 |
| LAN5 | 30 |
| LAN6 | 60 |
| LAN7 | 40 |
| LAN8 | 60 |


每个子网，需要预留两个地址，即网络地址和广播地址。所以按照主机数量从多到少进行划分。考虑到网络总地址为192.168.1.0/24，共有256（32-24=8，256为2的8次方）个地址。

因此进行如下的划分。

| VLAN | 主机数 | 所需地址 | 子网掩码 | 子网地址 | 可用地址范围 | 广播地址 |
| --- | --- | --- | --- | --- | --- | --- |
| LAN6 | 60 | 62 | /26 (255.255.255.192) | 192.168.1.0 | 192.168.1.1 – 192.168.1.62 | 192.168.1.63 |
| LAN8 | 60 | 62 | /26 | 192.168.1.64 | 192.168.1.65 – 192.168.1.126 | 192.168.1.127 |
| LAN7 | 40 | 42 | /26 | 192.168.1.128 | 192.168.1.129 – 192.168.1.190 | 192.168.1.191 |
| LAN5 | 30 | 32 | /27 (255.255.255.224) | 192.168.1.192 | 192.168.1.193 – 192.168.1.222 | 192.168.1.223 |
| LAN3 | 10 | 12 | /28 | 192.168.1.224 | 192.168.1.225 – 192.168.1.238 | 192.168.1.239 |
| LAN1 | 2 | 4 | /30 (255.255.255.252) | 192.168.1.240 | 192.168.1.241 – 192.168.1.242 | 192.168.1.243 |
| LAN2 | 2 | 4 | /30 | 192.168.1.244 | 192.168.1.245 – 192.168.1.246 | 192.168.1.247 |
| LAN4 | 2 | 4 | /30 | 192.168.1.248 | 192.168.1.249 – 192.168.1.250 | 192.168.1.251 |


剩余地址：192.168.1.252 – 192.168.1.255作为保留。

---

## Dijkstra算法
在计算机网络中，Dijkstra算法被广泛应用于链路状态路由协议（Link State Routing Protocol）中，用来计算从一个源节点到其他所有节点的最短路径。这个算法的本质是一种贪心算法，它会不断选择当前已知的最短路径进行扩展，最终找到所有节点的最短路径。最典型的实际应用就是在OSPF（开放最短路径优先）路由协议中，Dijkstra算法被用于构建最短路径树（SPT），从而决定路由器该如何转发数据包。

```text
Dijkstra(Graph, source):
    创建距离表 dist，所有点初始化为 ∞
    dist[source] ← 0

    创建优先队列 Q
    将 (dist[source], source) 加入 Q

    while Q 不为空:
        从 Q 中取出 dist最小的节点 u
        如果 u 已经被访问过，跳过

        标记 u 为已访问

        对于 u 的每个邻接点 v:
            如果 v 未访问过 且 dist[v] > dist[u] + weight(u, v):
                dist[v] ← dist[u] + weight(u, v)Add commentMore actions
                将 (dist[v], v) 加入 Q

    返回 dist
```

下面是一个结合**Dijkstra算法与网络拓扑图**的具体题目示例：

在如下网络拓扑中，节点代表路由器，边上的数字表示该链路的代价。请使用 Dijkstra算法 以节点 A 为起点，计算到其他所有节点的最短路径和代价。

```
   2       1
A --- B ------- C
|     |         |
5     3         4
|     |         |
D --- E ------- F
    1      2
```

我们从节点 **A** 开始，初始化每个节点的距离为∞，只有起点A的距离为0。然后我们开始Dijkstra算法的迭代，寻找最短路径。

**初始状态**：

+ 已处理集合：{}
+ 距离表：A=0, B=∞, C=∞, D=∞, E=∞, F=∞

**第一步**：选择距离最小的未处理节点A，加入集合。

+ 邻居B：距离为0 + 2 = 2，更新B为2
+ 邻居D：距离为0 + 5 = 5，更新D为5
+ 状态更新：B=2, D=5，其它不变

**第二步**：选距离最小的节点B（2），处理它。

+ 邻居A已处理，跳过
+ 邻居C：2 + 1 = 3，更新C为3
+ 邻居E：2 + 3 = 5，更新E为5（之前是∞）
+ 状态更新：C=3, E=5

**第三步**：选C（3）处理

+ 邻居B已处理
+ 邻居F：3 + 4 = 7，更新F为7

**第四步**：选D（5）处理

+ 邻居A已处理
+ 邻居E：5 + 1 = 6，但E当前已是5，保留原值

**第五步**：选E（5）处理

+ 邻居B已处理
+ 邻居D已处理
+ 邻居F：5 + 2 = 7，F原来是7，不变

**第六步**：处理最后一个F

至此所有节点处理完，得到的最短路径距离如下：

| 目标节点 | 最短路径 | 代价 |
| --- | --- | --- |
| A | A | 0 |
| B | A → B | 2 |
| C | A → B → C | 3 |
| D | A → D | 5 |
| E | A → B → E | 5 |
| F | A → B → C → F 或 A → B → E → F | 7 |


---

## NAT
NAT（网络地址转换，Network Address Translation） 是一种将私有网络中的 IP 地址转换为公有网络 IP 地址的技术，主要用于在多个设备共用一个公网 IP 的场景中。

本质：是一种将 IP 数据包中的 IP 地址（源地址或目的地址）进行转换的技术，通常用于实现私有网络与公共网络之间的地址映射，解决 IPv4 地址资源不足的问题。

> 举例：你家里有 5 台设备（电脑、手机、电视等），但你的 ISP 只给你一个公网 IP。通过 NAT 路由器，这 5 台设备可以同时访问互联网，而外部看起来它们都来自同一个 IP 地址。
> NAT的作用主要是：节省公网 IP 资源，使多台内网主机通过一个公网 IP 访问互联网；提高网络安全性，外部网络无法直接访问内网主机，起到一定的防护作用；实现网络结构隔离，内外网结构分离，提高网络管理的灵活性。

---

### NAT过程举例
**网络拓扑结构简述**

整个网络由两个局域网和一个公网构成：

局域网A（右侧）包含多台设备，如：

电脑1：内网IP为 192.168.3.74，浏览器使用端口 2111

手机1：内网IP为 192.168.3.48，微信使用端口 9855

电视1：IP为 192.168.3.3

所有设备默认网关为 192.168.3.1（即 NAT 路由器）

局域网B（左侧）有设备：

手机2：IP为 192.168.3.74，微信端口 6666

电脑2：IP为 192.168.3.3

默认网关同样为 192.168.3.1（自己的 NAT 路由器）

公网服务器：如 DiliDili 视频网站，公网IP 为 200.1.1.4，服务端口为 80

**NAT 表的运作机制**

当内网设备访问外网服务器时，NAT 路由器会创建一个 NAT 表项，用来记录 IP 和端口的转换关系。例如：

手机1（192.168.3.48:9855） 访问外网时，被 NAT 路由器转换为：

`外网地址：59.175.49.153:7788`

电脑1（192.168.3.74:2111） 发起网页请求，被转换为：

`外网地址：59.175.49.153:23333`

这个 NAT 表可以理解为一个映射字典，外网服务器回应时会根据这个映射被正确路由回到原设备。

类似地，左边局域网中：

手机2（192.168.3.74:6666） 访问公网后，NAT 路由器将其转换为：

`外网地址：66.211.88.55:4096`

**双向通信过程举例说明**

以“手机1访问 DiliDili 网站”为例：

手机1浏览器访问公网IP 200.1.1.4 的 Web 服务（端口 80）；

NAT 路由器将源 IP 和端口从 192.168.3.48:9855 转换为 59.175.49.153:7788；

外网服务器将回应发回 59.175.49.153:7788；

NAT 路由器根据 NAT 表找到对应设备，重写目标地址为 192.168.3.48:9855 并发回手机1。

**任务说明**

假设有几个任务，用于帮助理解 NAT 的通信过程：

手机1 → 手机2 发微信文字

手机2 → 手机1 发图片

电脑1 → 公网服务器 请求网页数据

公网服务器 → 电脑1 返回网页内容

这些过程都需要 NAT 完成正确的地址和端口转换才能通信成功。

---

**NAT总结**

NAT（网络地址转换，Network Address Translation）是一种在私有网络与公网之间进行IP地址转换的技术，主要用于节省公网IP地址资源，同时实现内网与外网之间的通信。

IP地址分为两类：

+ **私有IP地址（内网IP）**：由局域网内部自行分配的地址，适用于局域网内的设备通信。这些地址不可用于互联网通信，范围包括：

10.0.0.0 ～ 10.255.255.255

172.16.0.0 ～ 172.31.255.255

192.168.0.0 ～ 192.168.255.255

每个局域网都可以使用这些地址，并且它们是可复用的。只要在本地唯一即可，不需要全球唯一。

+ **公网IP地址（外网IP）**：由 ISP（互联网服务提供商）分配，是全球唯一的，主要用于设备与互联网之间的通信。

NAT 的核心作用是：在数据包转发过程中，实现内网IP和公网IP之间的相互转换。这项转换由NAT路由器完成，NAT 路由器在进行地址转换时，会维护一张NAT表，记录转换关系，格式：`内网IP:端口号 <-> 外网IP:端口号`

NAT 路由器的功能包括传输层的端口映射功能。当一个数据包从内网发送到外网时，NAT 路由器会改变其源IP地址和源端口号；从外网返回数据到内网时，则会改变目标IP地址和目标端口号。这些操作使得多个内网主机可以共用一个公网IP地址与外部通信。

对比普通路由器，普通路由器仅转发数据包，不修改源或目的IP地址，仅操作网络层及以下内容；而NAT 路由器会修改 IP 地址和端口号，包含部分传输层功能，实现了地址转换的能力。

---

## SDN
软件定义网络（SDN，Software-Defined Networking）是一种新兴的网络架构，旨在提高网络的灵活性、可编程性和可管理性。它通过将网络控制平面与数据转发平面分离，简化了网络管理并促进网络创新。

SDN 是一种网络架构理念，核心思想是将网络设备（如交换机、路由器）的控制平面（Control Plane）与数据平面（Data Plane）分离：

控制平面：负责决策，比如路径选择、策略管理等。

数据平面：负责转发数据包。

在传统网络中，控制平面和数据平面耦合在每个设备内部。而在 SDN 中，控制平面集中化，交由一个中央控制器完成，数据平面仅负责转发。

**SDN 的目的**

+ 集中控制与简化管理：通过集中式控制器统一管理整个网络，简化配置和维护。
+ 增强网络可编程性：使得网络行为可以通过软件动态编程，而不是依赖厂商固件。
+ 灵活应对业务变化：能快速部署新服务或调整策略。
+ 开放接口与厂商解耦：促进网络设备和控制逻辑的标准化和开放性。

**SDN的优点**

+ 集中控制：控制逻辑集中在控制器中，便于统一策略部署和故障诊断。
+ 灵活性高：网络策略可通过软件更新，快速响应业务变化。
+ 降低成本：使用通用硬件，减少对专用网络设备的依赖。
+ 可编程性强：允许开发者通过 API 编写定制网络应用。
+ 提高安全性：控制器可全局视图检测异常流量，实现动态安全防护。

**SDN的架构组成**

1. 应用层（Application Layer）

包含各种网络应用，如负载均衡、流量工程、安全策略等。

通过 北向接口（Northbound API） 与控制层交互。

2. 控制层（Control Layer）

核心组件是 SDN 控制器（如 OpenDaylight, ONOS, Ryu）。

负责全局网络状态的维护与控制策略的下发。

提供北向接口与应用通信，南向接口与设备通信。

3. 基础设施层（Infrastructure Layer）

包括物理交换机、虚拟交换机、路由器等设备。

通过 南向接口（Southbound API）（如 OpenFlow 协议）接收控制器的指令，执行数据转发。

---

## 网络层功能总结
| 网络层功能 | 实现方式/体现在哪些协议中 |
| --- | --- |
| 逻辑寻址 | IP协议定义地址结构（IPv4/IPv6） |
| 路由选择与转发 | 路由器根据IP头中的目的地址 + 路由表进行下一跳转发 |
| 分段与重组 | IP协议支持分片字段，如标识符、偏移量、MF标志 |
| 差错通知与控制 | ICMP提供网络错误报告机制，例如TTL超时、目标不可达等 |
| 地址解析 | ARP协议用于IP到MAC的转换 |
| 路由表生成与维护 | RIP、OSPF、BGP等动态路由协议支持网络拓扑自动发现与更新 |








