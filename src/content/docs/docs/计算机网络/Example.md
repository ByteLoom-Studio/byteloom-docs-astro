---
title : Example
sidebar:
  order : 8
---

> Author : CG

本节提供的是可能会出现在论述题中的部分过程解析

## 基于拓扑的Web请求历程

“拓扑”指的是系统中各个组件（例如客户端、服务器、路由器、负载均衡器、数据库等）之间的连接结构。

例如，一个典型的 Web 系统拓扑可能包括：
```text
客户端 → 负载均衡器 → Web 服务器 → 应用服务器 → 数据库
                   ↓
             静态资源服务器（CDN）
```

假设用户在浏览器输入 `www.example.com`，下面是整个流程：

1. **DNS 查询（域名解析）**

浏览器查找 `www.example.com` 的 IP 地址，`先查本地缓存 → 再查操作系统缓存 → DNS 服务器`， 最终返回 Web 服务所在的 IP 地址。

2. **TCP 连接 + TLS 握手（如果是 HTTPS）**

浏览器与 Web 服务器建立 TCP 连接（三次握手）。如果是 HTTPS，还要进行 TLS 握手（协商加密算法、证书验证等）

3. **发送 HTTP 请求**

浏览器发送一个 HTTP 请求，通常为 `GET /index.html`，请求头中包含：Host、User-Agent、Accept 等信息

4. **负载均衡器处理请求（如有）**

请求可能先到达 **负载均衡器（Load Balancer）**，根据策略（如轮询、最少连接等）将请求转发到某台 Web 服务器

5. **Web 服务器处理请求**

接收到请求，判断是：
* 静态内容（图片、HTML）：自己返回
* 动态内容（如 PHP、Python 脚本）：转发给后端应用服务器

6. **应用服务器执行业务逻辑**

接收到 Web 服务器的请求，可能从数据库中查询数据，然后组装 HTML 页面或 JSON 数据，返回给 Web 服务器

7. **数据库访问（如有）**

应用服务器连接数据库（如 MySQL、MongoDB），查询或写入数据，返回结果给应用服务器

8. **Web 服务器将响应返回客户端**

返回 HTTP 响应，包括：
* 状态码（如 200 OK）
* 响应头（如 Content-Type）
* 响应体（HTML 页面或 JSON）

9. **浏览器渲染页面**

浏览器解析 HTML，遇到 CSS、JS、图片等资源，会发起更多的并发请求（可能走 CDN），渲染页面、执行脚本、加载样式

10. **页面完全加载完成（onload 事件）**

用户看到页面，可能开始交互（点击按钮、发送表单等）。

---

**总结图示**

```text
[浏览器]
   |
   ↓
[DNS 服务器] → 返回 IP
   |
   ↓
[负载均衡器]
   |
   ↓
[Web 服务器]
   |
   ↓
[应用服务器] → [数据库]
   |
   ↓
[返回 HTML/JSON]
   |
   ↓
[浏览器渲染页面]
```

## 客户机发送 HTTP 请求前的 DNS 查询与 ARP 过程详解

在用户访问网页（如 `www.google.com`）之前，必须先获得该域名对应的 IP 地址。这一过程涉及 DNS 查询和 ARP 协议的协同工作。以下为详细步骤说明：

步骤过程：

1. **生成 DNS 查询请求**

用户在浏览器输入网址 `www.google.com`。客户机发现本地没有对应的 IP 地址，需要通过 DNS 查询获取。客户机会构造一个 DNS 查询报文，准备通过网络发送到配置的 DNS 服务器（可能是运营商提供的或 8.8.8.8 等公共 DNS）。

2. **判断 DNS 服务器是否在同一子网**

客户机检查 DNS 服务器的 IP 地址。如果 DNS 服务器不在本地子网内（通常不是），则需要将查询报文发送到默认网关（路由器）由其转发。

3. **准备发送 DNS 查询前需确定网关的 MAC 地址**

以太网通信必须通过 MAC 地址进行，因此客户机必须先知道网关的 MAC 地址。客户机查看本地 ARP 表，发现没有网关（默认网关 IP）的 MAC 映射。

4. **发送 ARP 请求广播**

客户机会生成一个 ARP 请求报文，询问：“谁是网关 IP（如 192.168.1.1）？请告诉我你的 MAC 地址。” 

报文的封装结构如下：
- 目标 IP：网关 IP（例如 192.168.1.1）
- 目标 MAC：广播地址 `FF:FF:FF:FF:FF:FF`（表示局域网内所有设备）
    
报文通过以太网广播发送，所有局域网内的设备都能收到。

5. **网关响应 ARP 请求**

路由器（网关）识别出 ARP 请求是问它的，构造 ARP 响应报文。报文中包含：
- 源 IP：网关 IP
- 源 MAC：网关接口的实际 MAC 地址

ARP 响应通过单播方式发送回客户机。

6. **客户机接收 ARP 响应**

客户机接收到路由器的 ARP 响应，将网关 IP 和其 MAC 地址的映射关系添加到本地 ARP 表缓存中。

7. **封装并发送 DNS 查询报文**

客户机准备好发送 DNS 查询报文，执行如下封装过程：
- 应用层：DNS 报文
- 传输层：封装到 UDP 报文段（源端口随机，目的端口为 53）
- 网络层：封装到 IP 数据报（源 IP 为客户机 IP，目的 IP 为 DNS 服务器 IP）
- 数据链路层：封装为以太网帧
  - 源 MAC：客户机网卡的 MAC 地址
  - 目的 MAC：网关的 MAC 地址（来自 ARP 表）
以太网帧被发送到网关，准备通过路由器出局转发到 DNS 服务器。

8. **网关接收到以太网帧并转发**

路由器接收到来自客户机的 DNS 查询请求，根据信息转发至 DNS 服务器，客户端就进入等待响应的状态。

---

## DNS 查询响应的网络传输与处理过程

本节描述的是：客户端发送 DNS 查询报文后，如何经由路由器传输到 DNS 服务器，并收到回应，最终解析出目标域名的 IP 地址。

步骤过程：

1. **DNS 查询报文跨网络转发到 DNS 服务器**

客户机封装好的 DNS 查询报文，发送到默认网关；网关（路由器）根据其 **路由表** 判断下一跳，将数据包转发出去。数据包可能经过多个中间路由器，每个路由器都根据自己的路由表来决定转发方向。

这些路由表可能是根据以下协议动态生成的：
- **RIP**（Routing Information Protocol）：距离矢量协议，适用于小型网络。
- **OSPF**（Open Shortest Path First）：链路状态协议，适用于中到大型网络。
- **BGP**（Border Gateway Protocol）：自治系统之间的协议，用于互联网中的路径选择。

最终，DNS 查询数据包被送达指定的 DNS 服务器（如 8.8.8.8）。

2. **DNS 服务器处理查询并生成响应**

DNS 服务器收到 IP 数据报，进行逐层解封装，直到获取到 DNS 查询报文。它在本地 DNS 数据库或缓存中查找 `www.google.com` 的对应 IP 地址。

找到对应 IP 地址后，生成 DNS 回答报文，封装成 `UDP 数据段 → IP 数据报 → 以太网帧`

响应报文的目的 IP 是客户端 IP，目的 MAC 是路由器下一跳的 MAC。DNS 回应也需要跨越多个路由器，反向传输回客户端。

3. **客户机接收到 DNS 响应并解析 IP 地址**

客户机接收到封装好的 DNS 响应报文，进行解封装。

`解以太网帧 → 解 IP 层 → 解 UDP 层 → 得到 DNS 响应`

从 DNS 报文中提取出 `www.google.com` 对应的 IP 地址（例如：142.250.72.196）。客户机会将此 IP 缓存一段时间（依据 DNS 响应中的 TTL 值），用于后续请求。

## HTTP 请求的 TCP 建立与页面响应过程详解

本节描述的是：客户端在获取到目标服务器的 IP 地址后，如何通过 TCP 三次握手建立连接并发送 HTTP 请求，最终获取网页内容并显示在浏览器中。

步骤过程：

1. **客户端生成 TCP 套接字**

客户机准备访问网页内容，在操作系统中创建一个 TCP 套接字（Socket），指定：
- 目标 IP 地址：例如 `142.250.72.196`（来自 DNS 查询）
- 目标端口号：`80`（HTTP 默认端口）

此时客户端准备通过 TCP 协议建立连接。

2. **客户端发起 TCP 三次握手的第一次：SYN 报文**

客户机向服务器发送一个 TCP 报文段：
- 设置 `SYN` 标志位为 1
- 目标 IP：Web 服务器的 IP 地址
- 目标端口：80

该 TCP 报文经过封装（TCP → IP → 以太网）后被发送出去，并经过多次路由转发，最终抵达目标 Web 服务器。

3. **Web 服务器回应握手的第二次：SYN-ACK 报文**

Web 服务器收到客户端发来的 TCP SYN 报文。它回应一个 TCP 报文段：
- `SYN = 1`, `ACK = 1`
- 确认号为客户端初始序号 + 1

该报文封装并通过网络发送回客户端。

4. **客户端完成握手并发送 HTTP 请求**

客户端收到服务器的 SYN-ACK 报文后，发送第三次握手的 ACK 报文。同时，将 HTTP 请求报文写入 TCP 套接字，由操作系统构造 TCP 报文段。

TCP 报文携带 HTTP 请求（如：`GET / HTTP/1.1`），目的 IP 为 Web 服务器 IP，目的端口为 80

报文被封装为 IP 数据报并路由到目标服务器。

5. **Web 服务器处理请求并发送 HTTP 响应**

Web 服务器接收到 TCP 报文，提取 HTTP 请求。根据请求内容生成 HTTP 响应报文：
- 状态码：如 `200 OK`
- 响应体：网页的 HTML、CSS、JS 等内容

将响应数据写入 TCP 套接字，并封装为 TCP 报文段，发送回客户端。

6. **客户端接收响应并显示网页内容**

客户机接收到 HTTP 响应的 TCP 报文段，从 TCP 套接字中读取数据，解出 HTTP 响应内容。浏览器解析 HTML 内容，渲染网页，用户可以看到页面。